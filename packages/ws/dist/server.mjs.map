{"version":3,"sources":["../src/wsAdapter-server.ts"],"sourcesContent":["import { TsIoServerAdapter, TsIoServerEmitter } from '@ts-io/core'\nimport { type IoContract } from '@ts-io/core'\nimport { v4 as uuidv4 } from 'uuid'\nimport ws, { WebSocketServer } from 'ws'\n\nexport type TsIoWebSocket = ws.WebSocket & { id?: string }\n\ntype TsIoWebSocketServer = Omit<WebSocketServer, 'clients'> & {\n  clients: Set<TsIoWebSocket>\n}\n\nfunction createWsServerProxy<Contract extends IoContract>(\n  wsServer: TsIoWebSocketServer,\n  socket: TsIoWebSocket\n): TsIoServerAdapter<Contract> {\n  const emitToClient: TsIoServerEmitter = (to, data) => {\n    wsServer.clients.forEach(ws => {\n      // @FIXME: BROADCAST TO ALL CLIENTS FOR TESTING PURPOSES\n      if (/* ws.id === socketId &&  */ socket.readyState === socket.OPEN) {\n        ws.send(JSON.stringify(data))\n      }\n    })\n  }\n\n  return {\n    emitTo: (to, event, data) => {\n      const messageId = uuidv4()\n      emitToClient(to, { messageId, event, data })\n    },\n    // acknowledge: output => {\n    //   wsServer.clients.forEach(ws => {\n    //     if (socket.id === ws.id && socket.readyState === socket.OPEN) {\n    //       ws.send(JSON.stringify(output))\n    //     }\n    //   })\n    // },\n    on: (eventKey, handler) => {\n      socket.on('message', msg => {\n        const { messageId, event, data } = JSON.parse(msg.toString())\n        if (event === eventKey) {\n          handler(data, response => {\n            wsServer.clients.forEach(ws => {\n              if (socket.id === ws.id && socket.readyState === socket.OPEN) {\n                ws.send(JSON.stringify({ messageId, event, data: response }))\n              }\n            })\n          })\n        }\n      })\n    },\n  }\n}\n\nexport { createWsServerProxy }\n"],"mappings":";AAEA,SAAS,MAAM,cAAc;AAS7B,SAAS,oBACP,UACA,QAC6B;AAC7B,QAAM,eAAkC,CAAC,IAAI,SAAS;AACpD,aAAS,QAAQ,QAAQ,QAAM;AAE7B;AAAA;AAAA,QAAiC,OAAO,eAAe,OAAO;AAAA,QAAM;AAClE,WAAG,KAAK,KAAK,UAAU,IAAI,CAAC;AAAA,MAC9B;AAAA,IACF,CAAC;AAAA,EACH;AAEA,SAAO;AAAA,IACL,QAAQ,CAAC,IAAI,OAAO,SAAS;AAC3B,YAAM,YAAY,OAAO;AACzB,mBAAa,IAAI,EAAE,WAAW,OAAO,KAAK,CAAC;AAAA,IAC7C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAQA,IAAI,CAAC,UAAU,YAAY;AACzB,aAAO,GAAG,WAAW,SAAO;AAC1B,cAAM,EAAE,WAAW,OAAO,KAAK,IAAI,KAAK,MAAM,IAAI,SAAS,CAAC;AAC5D,YAAI,UAAU,UAAU;AACtB,kBAAQ,MAAM,cAAY;AACxB,qBAAS,QAAQ,QAAQ,QAAM;AAC7B,kBAAI,OAAO,OAAO,GAAG,MAAM,OAAO,eAAe,OAAO,MAAM;AAC5D,mBAAG,KAAK,KAAK,UAAU,EAAE,WAAW,OAAO,MAAM,SAAS,CAAC,CAAC;AAAA,cAC9D;AAAA,YACF,CAAC;AAAA,UACH,CAAC;AAAA,QACH;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF;AACF;","names":[]}