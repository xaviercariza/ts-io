{"version":3,"sources":["../src/wsAdapter-client.ts"],"sourcesContent":["import { type IoContract, type TsIoClientAdapter } from '@ts-io/core'\nimport WebSocket from 'ws'\n\nfunction generateRequestId(): string {\n  return Math.random().toString(36).substring(2, 10)\n}\n\nfunction createWsClientProxy<Contract extends IoContract>(\n  socket: WebSocket\n): TsIoClientAdapter<Contract> {\n  const requestCallbacks: Map<keyof Contract['actions'], (data: any) => void> = new Map()\n  const eventsCallbacks: Map<keyof Contract['listeners'], (data: any) => void> = new Map()\n\n  socket.addEventListener('message', event => {\n    const data = JSON.parse(event.data.toString())\n    const messageId = data.messageId\n    if (requestCallbacks.has(messageId)) {\n      const callback = requestCallbacks.get(messageId)\n      if (callback) {\n        requestCallbacks.delete(messageId)\n        callback(data)\n      }\n    }\n\n    if (eventsCallbacks.has(data.event)) {\n      const callback = eventsCallbacks.get(data.event)\n      if (callback) {\n        callback(data)\n      }\n    }\n  })\n\n  return {\n    emit: (event, payload) => {\n      const messageId = generateRequestId()\n      const promise = new Promise<any>((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          requestCallbacks.delete(messageId)\n          reject(new Error('Request timed out'))\n        }, 5000)\n\n        requestCallbacks.set(messageId, (response: any) => {\n          clearTimeout(timeout)\n          if (response.data.success) {\n            resolve(response.data.data)\n          }\n        })\n      })\n\n      socket.send(JSON.stringify({ messageId, event, data: payload }))\n\n      return promise\n    },\n    on: (event, callback) => {\n      eventsCallbacks.set(event, (response: any) => {\n        callback(response.data)\n      })\n    },\n  }\n}\n\nexport { createWsClientProxy }\n"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA,SAAS,oBAA4B;AACnC,SAAO,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,GAAG,EAAE;AACnD;AAEA,SAAS,oBACP,QAC6B;AAC7B,QAAM,mBAAwE,oBAAI,IAAI;AACtF,QAAM,kBAAyE,oBAAI,IAAI;AAEvF,SAAO,iBAAiB,WAAW,WAAS;AAC1C,UAAM,OAAO,KAAK,MAAM,MAAM,KAAK,SAAS,CAAC;AAC7C,UAAM,YAAY,KAAK;AACvB,QAAI,iBAAiB,IAAI,SAAS,GAAG;AACnC,YAAM,WAAW,iBAAiB,IAAI,SAAS;AAC/C,UAAI,UAAU;AACZ,yBAAiB,OAAO,SAAS;AACjC,iBAAS,IAAI;AAAA,MACf;AAAA,IACF;AAEA,QAAI,gBAAgB,IAAI,KAAK,KAAK,GAAG;AACnC,YAAM,WAAW,gBAAgB,IAAI,KAAK,KAAK;AAC/C,UAAI,UAAU;AACZ,iBAAS,IAAI;AAAA,MACf;AAAA,IACF;AAAA,EACF,CAAC;AAED,SAAO;AAAA,IACL,MAAM,CAAC,OAAO,YAAY;AACxB,YAAM,YAAY,kBAAkB;AACpC,YAAM,UAAU,IAAI,QAAa,CAAC,SAAS,WAAW;AACpD,cAAM,UAAU,WAAW,MAAM;AAC/B,2BAAiB,OAAO,SAAS;AACjC,iBAAO,IAAI,MAAM,mBAAmB,CAAC;AAAA,QACvC,GAAG,GAAI;AAEP,yBAAiB,IAAI,WAAW,CAAC,aAAkB;AACjD,uBAAa,OAAO;AACpB,cAAI,SAAS,KAAK,SAAS;AACzB,oBAAQ,SAAS,KAAK,IAAI;AAAA,UAC5B;AAAA,QACF,CAAC;AAAA,MACH,CAAC;AAED,aAAO,KAAK,KAAK,UAAU,EAAE,WAAW,OAAO,MAAM,QAAQ,CAAC,CAAC;AAE/D,aAAO;AAAA,IACT;AAAA,IACA,IAAI,CAAC,OAAO,aAAa;AACvB,sBAAgB,IAAI,OAAO,CAAC,aAAkB;AAC5C,iBAAS,SAAS,IAAI;AAAA,MACxB,CAAC;AAAA,IACH;AAAA,EACF;AACF;","names":[]}